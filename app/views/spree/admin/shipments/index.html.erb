<%= render :partial => 'spree/admin/shared/sub_menu/configuration' %>

<% content_for :page_title do %>
    配送予定一覧
<% end %>

<% content_for :page_actions do %>
<% end %>

<h4>定期購入予定の商品</h4>
<div style="maegin-top: 100px;">
  <%= form_tag admin_shipments_path, method: :get do %>
      <div class="form-group row">
        <label for="date" class="col-sm-3">この日までに再注文される定期購入</label>
        <div class="col-sm-3">
          <div class="input-group">
            <%= text_field_tag :date, datepicker_field_value(@date || 0.days.since.next_week(:monday)), class: 'datepicker-d form-control' %>
            <span class="input-group-btn">
		          <button type="submit" class="btn btn-primary">検索</button>
            </span>
          </div>
        </div>
      </div>
  <% end %>
</div>
<hr>
<% if @products.present? %>
    <table class="table table-striped">
      <thead>
      <th>商品ID</th>
      <th>商品名</th>
      <th>SLUG</th>
      <th>個数</th>
      <th>在庫</th>
      </thead>
      <tbody>
      <% @products.group_by { |p| p.id }.to_h.each do |k, v| %>
          <% stock = v.first.stock_items.sum(:count_on_hand) %>
          <tr style="background-color: <%= v.count > stock ? '#f2dede' : '' %>">
            <td><%= v.first.id %></td>
            <td><%= v.first.name %></td>
            <td><%= v.first.slug %></td>
            <td><%= v.count %></td>
            <td><%= stock %></td>
          </tr>
      <% end %>
      </tbody>
    </table>
    <% else %>
    指定日までに再配送予定の商品はありません
<% end %>

<hr>

<h4>現在配送準備中の商品</h4>
<% if @pending_products.present? %>
    <table class="table table-striped">
      <thead>
      <th>商品ID</th>
      <th>商品名</th>
      <th>SLUG</th>
      <th>個数</th>
      <th>在庫</th>
      </thead>
      <tbody>
      <% @pending_products.group_by { |p| p.id }.to_h.each do |k, v| %>
          <% stock = v.first.stock_items.sum(:count_on_hand) %>
          <tr style="background-color: <%= v.count > stock ? '#f2dede' : '' %>">
            <td><%= v.first.id %></td>
            <td><%= v.first.name %></td>
            <td><%= v.first.slug %></td>
            <td><%= v.count %></td>
            <td><%= stock %></td>
          </tr>
      <% end %>
      </tbody>
    </table>
<% else %>
    現在配送準備中の商品はありません
<% end %>


<script type="text/javascript" charset="utf-8">
  $('.datepicker-d').datepicker({
    dateFormat: Spree.translations.date_picker,
    dayNames: Spree.translations.abbr_day_names,
    dayNamesMin: Spree.translations.abbr_day_names,
    firstDay: Spree.translations.first_day,
    monthNames: Spree.translations.month_names,
    prevText: Spree.translations.previous,
    nextText: Spree.translations.next,
    showOn: "focus",
    beforeShow: function (input, inst) {
      var calendar = inst.dpDiv;
      setTimeout(function () {
        calendar.position({
          my: 'right top',
          at: 'right bottom',
          of: input
        });
      }, 1);
    }
  });
</script>
